# ==================== BUILDER STAGE (OPTIMIZED) ====================
FROM node:18-bullseye AS builder

WORKDIR /usr/src/app

# 1. Copiar archivos de configuración (capa más estable)
COPY package*.json ./
COPY tsconfig.json ./
COPY prisma ./prisma/

# 2. Instalar solo dependencias de producción primero (mejor caching)
RUN npm ci --only=production

# 3. Copiar fuente y generar Prisma client
COPY src ./src
RUN npx prisma generate

# 4. Instalar devDependencies solo para build
RUN npm ci --only=development

# 5. Build con estructura corregida
COPY scripts ./scripts
RUN npm run build

# 6. Verificar estructura resultante
RUN ls -la dist/ && test -f dist/main.js

# ==================== PRODUCTION STAGE (SECURE) ====================
FROM node:18-bullseye-slim AS production

# 1. Instalar solo lo necesario para producción
RUN apt-get update && apt-get install -y \
    curl \
    openssl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

WORKDIR /usr/src/app

# 2. Crear usuario no-root con UID/GID específicos (mejor para volumes)
RUN groupadd -g 1001 nodejs && \
    useradd -r -u 1001 -g nodejs nodejs && \
    chown -R nodejs:nodejs /usr/src/app

# 3. Copiar desde builder con permisos correctos
COPY --from=builder --chown=nodejs:nodejs /usr/src/app/node_modules ./node_modules
COPY --from=builder --chown=nodejs:nodejs /usr/src/app/dist ./dist
COPY --from=builder --chown=nodejs:nodejs /usr/src/app/package.json ./
COPY --from=builder --chown=nodejs:nodejs /usr/src/app/prisma ./prisma

# 4. Variables de entorno runtime
ENV NODE_ENV=production \
    PORT=3001 \
    HOST=0.0.0.0

# 5. Healthcheck mejorado
HEALTHCHECK --interval=30s --timeout=5s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:3001/api/v1/health || exit 1

# 6. Exposición de puertos
EXPOSE 3001

# 7. Comando como usuario no-root
USER nodejs

# 8. Entrypoint para inyección de variables
ENTRYPOINT ["node"]
CMD ["dist/main.js"]
